#go@ sh build
#!/bin/sh
cd "${0%build}" || exit 1

build() {
	${X}g++ -c -O2 $C \
		-DCHARLS_LIBRARY_BUILD \
		-std=c++14 \
		-fvisibility=hidden -fvisibility-inlines-hidden \
		src/src/*.cpp -Isrc/src -Isrc/include \
		-Wl,--version-script=charls.version
	${X}gcc *.o -shared -o ../../bin/$P/$D $L
	rm -f      ../../bin/$P/$A
	${X}ar rcs ../../bin/$P/$A *.o
	rm *.o
}

if [ "$OSTYPE" = "msys" ]; then
	P=windows L="
		-s -static-libgcc -static-libstdc++
		-Wl,-Bstatic -lstdc++ -lpthread -Wl,-Bdynamic
	" D=charls.dll A=charls.a build
elif [ "${OSTYPE#darwin}" != "$OSTYPE" ]; then
	P=osx C="-arch x86_64" L="-arch x86_64 -install_name @rpath/libcharls.dylib" \
	D=libcharls.dylib A=libcharls.a build
else
	P=linux C="-fPIC" L="-s -static-libgcc -static-libstdc++" \
	D=libcharls.so A=libcharls.a build
fi
